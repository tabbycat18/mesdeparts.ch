<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>mesdepart.ch Dual Board</title>
  <style>
    /* Set your two URLs below (left and right). This file is meant to live on the tablet only. */
    :root {
      color-scheme: dark;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    .wrap {
      display: flex;
      height: 100vh;
      width: 100vw;
      gap: 2px;
      background: #000;
    }
    .pane {
      flex: 1 1 50%;
      border: none;
      background: #000;
    }
    .controls {
      position: fixed;
      top: 8px;
      left: 8px;
      right: 8px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #222;
      padding: 8px 10px;
      border-radius: 10px;
      color: #f5f5f5;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }
    .controls.is-hidden {
      display: none;
    }
    .controls__form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      width: 100%;
    }
    .controls__group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1 1 260px;
      min-width: 0;
    }
    .controls label {
      font-size: 0.85rem;
      color: #cfd6e0;
      white-space: nowrap;
    }
    .controls input[type="search"] {
      flex: 1 1 auto;
      min-width: 0;
      background: #0d0d0d;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 0.95rem;
    }
    .controls input[type="search"]::placeholder {
      color: #7d8491;
    }
    .controls button {
      background: #1f6feb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .controls button:hover {
      background: #2a7dfc;
    }
    .controls button.secondary {
      background: #2b2f3a;
      color: #d5d9e0;
    }
    .controls button.secondary:hover {
      background: #3a3f4b;
    }
    .status {
      font-size: 0.8rem;
      color: #9ec4ff;
      min-width: 160px;
      flex: 0 0 auto;
    }
    .status[data-state="error"] {
      color: #ff9aa2;
    }
    .suggestions {
      position: relative;
      width: 100%;
    }
    .suggestions__list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.92);
      border: 1px solid #222;
      border-radius: 8px;
      margin-top: 4px;
      padding: 4px;
      list-style: none;
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
      z-index: 20;
      display: none;
    }
    .suggestions__item {
      margin: 0;
      padding: 0;
    }
    .suggestions__button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: #f5f5f5;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .suggestions__button:hover,
    .suggestions__button:focus {
      background: rgba(255, 255, 255, 0.08);
      outline: none;
    }
    .controls-toggle {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 9;
      background: rgba(0, 0, 0, 0.8);
      color: #f5f5f5;
      border: 1px solid #222;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
    }
    .controls-toggle:hover {
      background: rgba(20, 20, 20, 0.95);
    }
    @media (max-width: 800px) {
      .controls {
        position: static;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
    }
    .warning {
      color: #fff;
      display: grid;
      place-items: center;
      text-align: center;
      padding: 1.5rem;
      gap: 0.5rem;
    }
    .warning code {
      background: #111;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <button type="button" class="controls-toggle" id="showControls" hidden>Show picker</button>
  <div class="controls">
    <form id="boardForm" class="controls__form">
      <div class="controls__group">
        <label for="leftUrl">Left</label>
        <div class="suggestions">
          <input
            id="leftUrl"
            name="left"
            type="search"
            inputmode="search"
            placeholder="Search station or paste URL"
            autocomplete="off"
            required
          />
          <ul class="suggestions__list" id="leftSuggestions" aria-label="Left station suggestions"></ul>
        </div>
      </div>
      <div class="controls__group">
        <label for="rightUrl">Right</label>
        <div class="suggestions">
          <input
            id="rightUrl"
            name="right"
            type="search"
            inputmode="search"
            placeholder="Search station or paste URL"
            autocomplete="off"
            required
          />
          <ul class="suggestions__list" id="rightSuggestions" aria-label="Right station suggestions"></ul>
        </div>
      </div>
      <button type="submit">Load boards</button>
      <button type="button" class="secondary" id="swapBtn">Swap</button>
      <button type="button" class="secondary" id="resetBtn">Reset</button>
      <button type="button" class="secondary" id="hideBtn">Hide</button>
      <button type="button" class="secondary" id="fullscreenBtn">Go fullscreen</button>
      <div class="status" id="status" aria-live="polite"></div>
    </form>
  </div>
  <div class="wrap" id="wrapper">
    <iframe class="pane" id="leftPane" title="Left board"></iframe>
    <iframe class="pane" id="rightPane" title="Right board"></iframe>
  </div>

  <script>
    // Replace these two URLs with the boards you want on the tablet.
    // Example: const LEFT_DEFAULT = "https://mesdeparts.ch/?stationName=...&stationId=...";
    const LEFT_DEFAULT = "https://mesdeparts.ch/?stationName=Lausanne%2C+Motte&stationId=8592082";
    const RIGHT_DEFAULT = "https://mesdeparts.ch/?stationName=Lausanne";
    const STORAGE_KEY = "dualBoardUrls.v1";

    const params = new URLSearchParams(location.search);
    const saved = (() => {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
      } catch {
        return {};
      }
    })();

    const sanitizeUrl = (url) => {
      if (!url) return "";
      try {
        const parsed = new URL(url);
        if (parsed.protocol !== "https:" && parsed.protocol !== "http:") return "";
        return parsed.toString();
      } catch {
        return "";
      }
    };

    const getStationNameFromUrl = (url) => {
      try {
        const params = new URL(url).searchParams;
        const name = params.get("stationName");
        return name ? decodeURIComponent(name) : "";
      } catch {
        return "";
      }
    };

    const leftUrl =
      sanitizeUrl(params.get("left")) ||
      sanitizeUrl(saved.left) ||
      LEFT_DEFAULT;
    const rightUrl =
      sanitizeUrl(params.get("right")) ||
      sanitizeUrl(saved.right) ||
      RIGHT_DEFAULT;

    const leftFrame = document.getElementById("leftPane");
    const rightFrame = document.getElementById("rightPane");
    const wrapper = document.getElementById("wrapper");
    const form = document.getElementById("boardForm");
    const leftInput = document.getElementById("leftUrl");
    const rightInput = document.getElementById("rightUrl");
    const leftSuggest = document.getElementById("leftSuggestions");
    const rightSuggest = document.getElementById("rightSuggestions");
    const statusEl = document.getElementById("status");
    const swapBtn = document.getElementById("swapBtn");
    const resetBtn = document.getElementById("resetBtn");
    const hideBtn = document.getElementById("hideBtn");
    const showBtn = document.getElementById("showControls");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const controls = document.querySelector(".controls");

    const initialLeftName = getStationNameFromUrl(leftUrl);
    const initialRightName = getStationNameFromUrl(rightUrl);

    leftInput.value = initialLeftName || leftUrl;
    rightInput.value = initialRightName || rightUrl;

    const setStatus = (msg, state = "info") => {
      statusEl.textContent = msg;
      statusEl.dataset.state = state;
    };

    const showControls = () => {
      controls.classList.remove("is-hidden");
      showBtn.hidden = true;
    };

    const hideControls = () => {
      controls.classList.add("is-hidden");
      showBtn.hidden = false;
    };

    showBtn.addEventListener("click", showControls);

    const isUrlish = (value) => /^https?:\/\//i.test(value.trim());

    const buildBoardUrl = (station) =>
      `https://mesdeparts.ch/?stationName=${encodeURIComponent(station.name)}&stationId=${encodeURIComponent(station.id)}`;

    const API_BASE =
      (typeof window !== "undefined" && window.__MD_API_BASE__) ||
      "https://transport.opendata.ch/v1";
    const LOCATIONS_ENDPOINT = `${API_BASE}/locations`;

    const isFullscreen = () =>
      !!(document.fullscreenElement || document.webkitFullscreenElement);

    const syncFullscreenLabel = () => {
      fullscreenBtn.textContent = isFullscreen() ? "Exit fullscreen" : "Go fullscreen";
    };

    const requestFullscreen = async () => {
      const el = document.documentElement;
      const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      if (fn) {
        await fn.call(el);
        return true;
      }
      return false;
    };

    const exitFullscreen = async () => {
      const fn = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
      if (fn) await fn.call(document);
    };

    fullscreenBtn.addEventListener("click", async () => {
      try {
        if (isFullscreen()) {
          await exitFullscreen();
        } else {
          const ok = await requestFullscreen();
          if (!ok) setStatus("Fullscreen not supported.", "error");
        }
      } catch (err) {
        setStatus("Fullscreen request blocked.", "error");
      } finally {
        syncFullscreenLabel();
      }
    });

    document.addEventListener("fullscreenchange", syncFullscreenLabel);
    document.addEventListener("webkitfullscreenchange", syncFullscreenLabel);
    syncFullscreenLabel();

    const applyBoards = (l, r, { updateQuery = true, showStatus = true } = {}) => {
      const cleanLeft = sanitizeUrl(l);
      const cleanRight = sanitizeUrl(r);
      if (!cleanLeft || !cleanRight) {
        if (showStatus) setStatus("Please enter valid http(s) URLs.", "error");
        return false;
      }

      leftFrame.src = cleanLeft;
      rightFrame.src = cleanRight;

      if (updateQuery) {
        const nextParams = new URLSearchParams();
        nextParams.set("left", cleanLeft);
        nextParams.set("right", cleanRight);
        history.replaceState({}, "", `${location.pathname}?${nextParams.toString()}`);
      }

      try {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({ left: cleanLeft, right: cleanRight }),
        );
      } catch {
        /* ignore */
      }

      if (showStatus) setStatus("Boards updated.");
      return true;
    };

    const debounce = (fn, delay) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    };

    const fetchStationsList = async (q, limit = 7) => {
      if (!q || q.length < 2 || isUrlish(q)) return [];
      try {
        const url = `${LOCATIONS_ENDPOINT}?query=${encodeURIComponent(q)}&limit=${encodeURIComponent(limit)}`;
        const res = await fetch(url, { mode: "cors", headers: { accept: "application/json" } });
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();
        const list = data.stations || data.stops || data.locations || [];
        return list
          .filter((s) => s && s.id && s.name)
          .map((s) => ({ id: s.id, name: s.name }));
      } catch {
        return [];
      }
    };

    const renderSuggestions = (container, stations, onSelect) => {
      container.innerHTML = "";
      if (!stations || !stations.length) {
        container.style.display = "none";
        return;
      }
      const frag = document.createDocumentFragment();
      stations.forEach((station) => {
        const li = document.createElement("li");
        li.className = "suggestions__item";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "suggestions__button";
        btn.textContent = station.name;
        btn.addEventListener("click", () => onSelect(station));
        li.appendChild(btn);
        frag.appendChild(li);
      });
      container.appendChild(frag);
      container.style.display = "block";
    };

    const setupStationSearch = (inputEl, listEl, side) => {
      const setStation = (station) => {
        const url = buildBoardUrl(station);
        inputEl.value = station.name;
        if (side === "left") {
          applyBoards(url, rightFrame.src || rightUrl);
        } else {
          applyBoards(leftFrame.src || leftUrl, url);
        }
        renderSuggestions(listEl, []);
        setStatus(`${station.name} loaded on ${side}.`);
      };

      const fetchStations = async (q) => {
        if (!q || q.length < 2) {
          renderSuggestions(listEl, []);
          return;
        }
        try {
          const stations = await fetchStationsList(q, 7);
          renderSuggestions(listEl, stations, setStation);
          if (!stations.length) {
            setStatus("No stations found, try another name.", "error");
          } else {
            setStatus("", "info");
          }
        } catch (err) {
          renderSuggestions(listEl, []);
          setStatus("Station lookup failed. Check connection.", "error");
        }
      };

      const debouncedFetch = debounce(fetchStations, 200);
      inputEl.addEventListener("input", (e) => {
        debouncedFetch(e.target.value.trim());
      });
      inputEl.addEventListener("focus", () => {
        inputEl.select();
        const val = inputEl.value.trim();
        if (val.length >= 2) {
          fetchStations(val);
        }
      });
      inputEl.addEventListener("blur", () => {
        setTimeout(() => renderSuggestions(listEl, []), 150);
      });
    };

    const initialApplied = applyBoards(leftUrl, rightUrl, { updateQuery: !!(params.get("left") || params.get("right")), showStatus: false });
    if (!initialApplied) {
      wrapper.innerHTML = `
        <div class="warning">
          <div>Enter two valid URLs below.</div>
          <div>You can also pass them via the address bar: <code>?left=...&right=...</code></div>
        </div>
      `;
    }

    const resolveValueToUrl = async (value) => {
      const trimmed = value.trim();
      if (!trimmed) return "";
      if (isUrlish(trimmed)) return sanitizeUrl(trimmed);
      const stations = await fetchStationsList(trimmed, 1);
      if (!stations.length) return "";
      return buildBoardUrl(stations[0]);
    };

    const applyFromInputs = async () => {
      const [resolvedLeft, resolvedRight] = await Promise.all([
        resolveValueToUrl(leftInput.value),
        resolveValueToUrl(rightInput.value),
      ]);
      if (!resolvedLeft || !resolvedRight) {
        setStatus("Please pick stations (select from suggestions) or paste full URLs.", "error");
        return;
      }
      leftInput.value = getStationNameFromUrl(resolvedLeft) || leftInput.value;
      rightInput.value = getStationNameFromUrl(resolvedRight) || rightInput.value;
      applyBoards(resolvedLeft, resolvedRight);
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      applyFromInputs();
    });

    swapBtn.addEventListener("click", () => {
      const currentLeft = leftInput.value.trim();
      leftInput.value = rightInput.value.trim();
      rightInput.value = currentLeft;
      applyFromInputs();
    });

    resetBtn.addEventListener("click", () => {
      leftInput.value = getStationNameFromUrl(LEFT_DEFAULT) || LEFT_DEFAULT;
      rightInput.value = getStationNameFromUrl(RIGHT_DEFAULT) || RIGHT_DEFAULT;
      applyFromInputs();
    });

    hideBtn.addEventListener("click", hideControls);

    setupStationSearch(leftInput, leftSuggest, "left");
    setupStationSearch(rightInput, rightSuggest, "right");
  </script>
</body>
</html>
