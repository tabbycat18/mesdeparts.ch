name: GTFS Static Refresh

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: gtfs-refresh
  cancel-in-progress: false

jobs:
  refresh-gtfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend dependencies
        working-directory: rt/backend
        run: npm ci

      - name: Refresh GTFS if needed
        working-directory: rt/backend
        run: node scripts/refreshGtfsIfNeeded.js
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          OPENTDATA_GTFS_RT_KEY: ${{ secrets.OPENTDATA_GTFS_RT_KEY }}
          OPENTDATA_GTFS_SA_KEY: ${{ secrets.OPENTDATA_GTFS_SA_KEY }}

      - name: Smoke-test optimize_stop_search.sql (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        working-directory: rt/backend
        run: psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f sql/optimize_stop_search.sql
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
