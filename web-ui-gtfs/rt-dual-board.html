<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Mes Départs — Dual board</title>
    <link rel="icon" type="image/svg+xml" href="bus-icon-1.svg" />
    <link rel="apple-touch-icon" href="bus-icon-1.png" />
    <meta name="theme-color" content="#01157f" />
    <script>window.__MD_API_BASE__ = "https://api.mesdeparts.ch";</script>
    <link rel="preload" href="rt-style.css" as="style" />
    <link rel="modulepreload" href="rt-logic.js" as="script" />
    <link rel="modulepreload" href="ui.v2026-01-03-13.js" />
    <link rel="modulepreload" href="rt-state.js" />
    <link rel="modulepreload" href="i18n.v2026-01-03-13.js" />
    <link rel="modulepreload" href="infoBTN.v2026-01-03-13.js" />
    <link rel="modulepreload" href="favourites.v2026-01-03-13.js" />
    <link rel="preconnect" href="https://api.mesdeparts.ch" crossorigin />
    <link rel="stylesheet" href="rt-style.css" />
  </head>
  <body class="dual-body">
    <div class="dual-shell">
      <header class="dual-header">
        <div>
          <div class="dual-title-row">
            <div class="dual-title">Dual board</div>
            <div class="dual-version">v1.5.8</div>
          </div>
          <div id="dual-status" class="dual-status" aria-live="polite"></div>
        </div>
        <div class="dual-actions">
          <div class="language-switcher language-switcher--inline dual-lang-switcher">
            <label class="sr-only" for="language-select-global">Langue</label>
            <select
              id="language-select-global"
              class="language-select"
              aria-label="Langue"
            ></select>
          </div>
          <button id="swapBtn" class="filters-pill dual-action" type="button">Échanger</button>
          <button id="resetBtn" class="filters-pill dual-action" type="button">Réinitialiser</button>
          <button id="hideBtn" class="filters-pill dual-action" type="button" aria-pressed="false">
            Masquer les contrôles
          </button>
          <button id="fullscreenBtn" class="filters-pill dual-action" type="button">Plein écran</button>
          <button id="info-btn" class="info-button" type="button" aria-label="Informations">
            <span class="info-button__icon">i</span>
          </button>
        </div>
      </header>

      <section class="dual-controls" id="dual-controls">
        <div class="dual-picker-grid">
          <div class="dual-picker" data-side="left">
            <section class="station-card station-card-inline">
              <div class="station-card-topline">
                <div class="station-card-topline-right">
                  <button
                    id="board-mode-toggle-left"
                    class="filters-pill mode-pill"
                    type="button"
                    aria-pressed="false"
                  >
                    <span class="mode-pill__label">Tableau</span>
                    <span id="board-mode-state-left" class="mode-pill__state">ON</span>
                  </button>
                </div>
              </div>

              <div class="station-card-collapsible">
                <label for="station-input-left">Recherche d'arrêt</label>
                <div class="station-input-block">
                  <div class="station-input-wrapper">
                    <input
                      id="station-input-left"
                      type="text"
                      placeholder="Lausanne, motte"
                      autocomplete="off"
                    />
                    <button
                      id="station-search-left"
                      class="search-button"
                      type="button"
                      aria-label="Autour de moi"
                      title="Autour de moi"
                    >
                      <svg viewBox="0 0 32 32" focusable="false" aria-hidden="true">
                        <path
                          fill="currentColor"
                          d="M16.114-0.011c-6.559 0-12.114 5.587-12.114 12.204 0 6.93 6.439 14.017 10.77 18.998 0.017 0.020 0.717 0.797 1.579 0.797h0.076c0.863 0 1.558-0.777 1.575-0.797 4.064-4.672 10-12.377 10-18.998 0-6.618-4.333-12.204-11.886-12.204zM16.515 29.849c-0.035 0.035-0.086 0.074-0.131 0.107-0.046-0.032-0.096-0.072-0.133-0.107l-0.523-0.602c-4.106-4.71-9.729-11.161-9.729-17.055 0-5.532 4.632-10.205 10.114-10.205 6.829 0 9.886 5.125 9.886 10.205 0 4.474-3.192 10.416-9.485 17.657zM16.035 6.044c-3.313 0-6 2.686-6 6s2.687 6 6 6 6-2.687 6-6-2.686-6-6-6zM16.035 16.044c-2.206 0-4.046-1.838-4.046-4.044s1.794-4 4-4c2.207 0 4 1.794 4 4 0.001 2.206-1.747 4.044-3.954 4.044z"
                        />
                      </svg>
                    </button>
                    <button
                      id="station-fav-toggle-left"
                      class="fav-toggle"
                      type="button"
                      aria-label="Ajouter aux favoris"
                      title="Ajouter aux favoris"
                    >
                      <span class="fav-toggle__icon" aria-hidden="true">☆</span>
                    </button>
                    <button
                      id="favorites-only-toggle-left"
                      class="fav-pill fav-pill--inline"
                      type="button"
                      aria-pressed="false"
                      aria-expanded="false"
                      aria-controls="favorites-popover-left"
                    >
                      <span class="fav-pill__icon" aria-hidden="true">★</span>
                      <span class="fav-pill__label">Mes favoris</span>
                    </button>
                    <div
                      id="favorites-popover-left"
                      class="fav-popover is-hidden"
                      role="dialog"
                      aria-modal="false"
                      aria-labelledby="favorites-popover-title-left"
                    >
                      <div class="fav-popover__header">
                        <div class="fav-popover__title" id="favorites-popover-title-left">
                          Mes favoris
                        </div>
                        <button class="fav-popover__close" type="button" data-fav-close="left">×</button>
                      </div>
                      <div class="chip-row" id="favorites-chip-list-left"></div>
                      <div class="filters-empty is-hidden" id="favorites-empty-left">
                        Aucun favori pour l'instant
                      </div>
                    </div>
                  </div>
                  <ul id="station-suggestions-left" class="station-suggestions"></ul>
                </div>

                <div class="view-section">
                  <div class="quick-controls__label">Affichage</div>
                  <div class="segmented-control" id="view-segment-left">
                    <button type="button" data-view="line" class="segmented-btn is-active">
                      Par ligne
                    </button>
                    <button type="button" data-view="time" class="segmented-btn">
                      Par min
                    </button>
                  </div>
                </div>

                <div class="dual-inline-actions">
                  <button
                    id="filters-open-left"
                    class="filters-pill"
                    type="button"
                    aria-controls="filters-popover-left"
                    aria-expanded="false"
                  >
                    <span class="filters-pill__icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" focusable="false">
                        <path
                          fill="currentColor"
                          d="M4 7c0-.55.45-1 1-1h14a1 1 0 0 1 0 2H5c-.55 0-1-.45-1-1Zm3 5c0-.55.45-1 1-1h8a1 1 0 0 1 0 2H8c-.55 0-1-.45-1-1Zm3 5c0-.55.45-1 1-1h2a1 1 0 0 1 0 2h-2c-.55 0-1-.45-1-1Z"
                        />
                      </svg>
                    </span>
                    <span>Filtres</span>
                  </button>
                </div>

                <div
                  id="filters-popover-left"
                  class="filters-popover is-hidden"
                  role="dialog"
                  aria-modal="false"
                  aria-labelledby="filters-sheet-title-left"
                >
                  <div class="filters-popover__header">
                    <div class="filters-popover__title" id="filters-sheet-title-left">Filtres</div>
                    <button class="filters-popover__close" type="button" data-filter-close="left">×</button>
                  </div>
                  <div class="filters-popover__body">
                    <section class="filters-section">
                      <div class="filters-section__title">Affichage</div>
                      <div class="switch-row">
                        <label class="switch-label" for="filters-hide-departure-left">
                          Masquer la colonne Départ (bus)
                        </label>
                        <input type="checkbox" id="filters-hide-departure-left" />
                      </div>
                    </section>
                  </div>
                  <footer class="filters-popover__footer">
                    <button class="ghost-button" type="button" data-filter-reset="left">
                      Réinitialiser
                    </button>
                    <button class="primary-button" type="button" data-filter-apply="left">
                      Appliquer
                    </button>
                  </footer>
                </div>
              </div>
            </section>
          </div>

          <div class="dual-picker" data-side="right">
            <section class="station-card station-card-inline">
              <div class="station-card-topline">
                <div class="station-card-topline-right">
                  <button
                    id="board-mode-toggle-right"
                    class="filters-pill mode-pill"
                    type="button"
                    aria-pressed="false"
                  >
                    <span class="mode-pill__label">Tableau</span>
                    <span id="board-mode-state-right" class="mode-pill__state">ON</span>
                  </button>
                </div>
              </div>

              <div class="station-card-collapsible">
                <label for="station-input-right">Recherche d'arrêt</label>
                <div class="station-input-block">
                  <div class="station-input-wrapper">
                    <input
                      id="station-input-right"
                      type="text"
                      placeholder="Lausanne"
                      autocomplete="off"
                    />
                    <button
                      id="station-search-right"
                      class="search-button"
                      type="button"
                      aria-label="Autour de moi"
                      title="Autour de moi"
                    >
                      <svg viewBox="0 0 32 32" focusable="false" aria-hidden="true">
                        <path
                          fill="currentColor"
                          d="M16.114-0.011c-6.559 0-12.114 5.587-12.114 12.204 0 6.93 6.439 14.017 10.77 18.998 0.017 0.020 0.717 0.797 1.579 0.797h0.076c0.863 0 1.558-0.777 1.575-0.797 4.064-4.672 10-12.377 10-18.998 0-6.618-4.333-12.204-11.886-12.204zM16.515 29.849c-0.035 0.035-0.086 0.074-0.131 0.107-0.046-0.032-0.096-0.072-0.133-0.107l-0.523-0.602c-4.106-4.71-9.729-11.161-9.729-17.055 0-5.532 4.632-10.205 10.114-10.205 6.829 0 9.886 5.125 9.886 10.205 0 4.474-3.192 10.416-9.485 17.657zM16.035 6.044c-3.313 0-6 2.686-6 6s2.687 6 6 6 6-2.687 6-6-2.686-6-6-6zM16.035 16.044c-2.206 0-4.046-1.838-4.046-4.044s1.794-4 4-4c2.207 0 4 1.794 4 4 0.001 2.206-1.747 4.044-3.954 4.044z"
                        />
                      </svg>
                    </button>
                    <button
                      id="station-fav-toggle-right"
                      class="fav-toggle"
                      type="button"
                      aria-label="Ajouter aux favoris"
                      title="Ajouter aux favoris"
                    >
                      <span class="fav-toggle__icon" aria-hidden="true">☆</span>
                    </button>
                    <button
                      id="favorites-only-toggle-right"
                      class="fav-pill fav-pill--inline"
                      type="button"
                      aria-pressed="false"
                      aria-expanded="false"
                      aria-controls="favorites-popover-right"
                    >
                      <span class="fav-pill__icon" aria-hidden="true">★</span>
                      <span class="fav-pill__label">Mes favoris</span>
                    </button>
                    <div
                      id="favorites-popover-right"
                      class="fav-popover is-hidden"
                      role="dialog"
                      aria-modal="false"
                      aria-labelledby="favorites-popover-title-right"
                    >
                      <div class="fav-popover__header">
                        <div class="fav-popover__title" id="favorites-popover-title-right">
                          Mes favoris
                        </div>
                        <button class="fav-popover__close" type="button" data-fav-close="right">×</button>
                      </div>
                      <div class="chip-row" id="favorites-chip-list-right"></div>
                      <div class="filters-empty is-hidden" id="favorites-empty-right">
                        Aucun favori pour l'instant
                      </div>
                    </div>
                  </div>
                  <ul id="station-suggestions-right" class="station-suggestions"></ul>
                </div>

                <div class="view-section">
                  <div class="quick-controls__label">Affichage</div>
                  <div class="segmented-control" id="view-segment-right">
                    <button type="button" data-view="line" class="segmented-btn is-active">
                      Par ligne
                    </button>
                    <button type="button" data-view="time" class="segmented-btn">
                      Par min
                    </button>
                  </div>
                </div>

                <div class="dual-inline-actions">
                  <button
                    id="filters-open-right"
                    class="filters-pill"
                    type="button"
                    aria-controls="filters-popover-right"
                    aria-expanded="false"
                  >
                    <span class="filters-pill__icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" focusable="false">
                        <path
                          fill="currentColor"
                          d="M4 7c0-.55.45-1 1-1h14a1 1 0 0 1 0 2H5c-.55 0-1-.45-1-1Zm3 5c0-.55.45-1 1-1h8a1 1 0 0 1 0 2H8c-.55 0-1-.45-1-1Zm3 5c0-.55.45-1 1-1h2a1 1 0 0 1 0 2h-2c-.55 0-1-.45-1-1Z"
                        />
                      </svg>
                    </span>
                    <span>Filtres</span>
                  </button>
                </div>

                <div
                  id="filters-popover-right"
                  class="filters-popover is-hidden"
                  role="dialog"
                  aria-modal="false"
                  aria-labelledby="filters-sheet-title-right"
                >
                  <div class="filters-popover__header">
                    <div class="filters-popover__title" id="filters-sheet-title-right">Filtres</div>
                    <button class="filters-popover__close" type="button" data-filter-close="right">×</button>
                  </div>
                  <div class="filters-popover__body">
                    <section class="filters-section">
                      <div class="filters-section__title">Affichage</div>
                      <div class="switch-row">
                        <label class="switch-label" for="filters-hide-departure-right">
                          Masquer la colonne Départ (bus)
                        </label>
                        <input type="checkbox" id="filters-hide-departure-right" />
                      </div>
                    </section>
                  </div>
                  <footer class="filters-popover__footer">
                    <button class="ghost-button" type="button" data-filter-reset="right">
                      Réinitialiser
                    </button>
                    <button class="primary-button" type="button" data-filter-apply="right">
                      Appliquer
                    </button>
                  </footer>
                </div>
              </div>
            </section>
          </div>
        </div>
      </section>

      <div class="dual-wrap" id="wrapper">
        <iframe class="dual-pane" id="leftPane" title="Board gauche" loading="lazy"></iframe>
        <iframe class="dual-pane" id="rightPane" title="Board droite" loading="lazy"></iframe>
      </div>
    </div>

    <button
      id="showControlsBtn"
      class="show-controls-button"
      type="button"
      aria-label="Afficher les contrôles"
      aria-hidden="true"
    >
      Afficher les contrôles
    </button>

    <div class="dual-version-float" aria-label="Version">v1.5.8</div>

    <script type="module">
      import { fetchStationSuggestions, fetchStationsNearby } from "./rt-logic.js";
      import { loadFavorites, addFavorite, removeFavorite, isFavorite } from "./favourites.v2026-01-03-13.js";
      import { LANGUAGE_OPTIONS, initI18n, setLanguage, t } from "./i18n.v2026-01-03-13.js";
      import {
        appState,
        API_MODE_BOARD,
        API_MODE_DIRECT,
        VIEW_MODE_LINE,
        VIEW_MODE_TIME,
        TRAIN_FILTER_ALL,
        TRAIN_FILTER_REGIONAL,
        TRAIN_FILTER_LONG_DISTANCE,
      } from "./rt-state.js";
      import { setupInfoButton } from "./infoBTN.v2026-01-03-13.js";

      const DEFAULT_LANG = initI18n();
      appState.apiMode = API_MODE_BOARD;
      appState.STATION = "Dual board";

      setupInfoButton();

      const params = new URLSearchParams(window.location.search || "");
      const autoFullscreen = params.get("fs") === "1" || params.get("fullscreen") === "1";

      const STORAGE_KEY = "dualBoardPrefs.v2";
      const LEGACY_STORAGE_KEY = "dualBoardUrls.v1";
      const BASE_BOARD_URL = new URL("./", window.location.href);

      const VALID_VIEWS = new Set([
        VIEW_MODE_LINE,
        VIEW_MODE_TIME,
        TRAIN_FILTER_ALL,
        TRAIN_FILTER_REGIONAL,
        TRAIN_FILTER_LONG_DISTANCE,
      ]);
      const VALID_LANGS = new Set(LANGUAGE_OPTIONS.map((opt) => opt.code));
      let currentLanguage = DEFAULT_LANG;
      const urlLang = params.get("lang");
      const normalizedUrlLang = normalizeLang(urlLang);
      if (normalizedUrlLang) currentLanguage = normalizedUrlLang;
      setLanguage(currentLanguage);
      appState.language = currentLanguage;

      const LEFT_DEFAULT = {
        stationName: "Lausanne, motte",
        stationId: "8592082",
        view: VIEW_MODE_LINE,
        hideDeparture: false,
        apiMode: API_MODE_BOARD,
        language: currentLanguage,
      };

      const RIGHT_DEFAULT = {
        stationName: "Lausanne",
        stationId: null,
        view: VIEW_MODE_LINE,
        hideDeparture: false,
        apiMode: API_MODE_BOARD,
        language: currentLanguage,
      };
      const BUS_VIEW_OPTIONS = [
        { v: VIEW_MODE_LINE, label: () => t("viewOptionLine") },
        { v: VIEW_MODE_TIME, label: () => t("viewOptionTime") },
      ];
      const TRAIN_VIEW_OPTIONS = [
        { v: TRAIN_FILTER_ALL, label: () => t("trainFilterAll") },
        { v: TRAIN_FILTER_REGIONAL, label: () => t("trainFilterRegional") },
        { v: TRAIN_FILTER_LONG_DISTANCE, label: () => t("trainFilterLongDistance") },
      ];

      const TRAIN_VIEWS = new Set([
        TRAIN_FILTER_ALL,
        TRAIN_FILTER_REGIONAL,
        TRAIN_FILTER_LONG_DISTANCE,
      ]);

      const BUS_VIEWS = new Set([VIEW_MODE_LINE, VIEW_MODE_TIME]);

      const isTrainView = (val) => TRAIN_VIEWS.has(val);
      const isBusView = (val) => BUS_VIEWS.has(val);

      const normalizeViewByType = (val, isTrain) => {
        const normalized = normalizeView(val);
        if (isTrain) return isTrainView(normalized) ? normalized : TRAIN_FILTER_ALL;
        return isBusView(normalized) ? normalized : VIEW_MODE_LINE;
      };

      const statusEl = document.getElementById("dual-status");
      const controls = document.getElementById("dual-controls");
      const wrapper = document.getElementById("wrapper");
      const leftFrame = document.getElementById("leftPane");
      const rightFrame = document.getElementById("rightPane");
      const hideBtn = document.getElementById("hideBtn");
      const showControlsBtn = document.getElementById("showControlsBtn");
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const swapBtn = document.getElementById("swapBtn");
      const resetBtn = document.getElementById("resetBtn");
      const languageSelect = document.getElementById("language-select-global");
      const infoBtn = document.getElementById("info-btn");

      const sideLabel = (side) => (side === "right" ? t("dualSideRight") : t("dualSideLeft"));

      function setStatus(msg, state = "info") {
        if (!statusEl) return;
        statusEl.textContent = msg || "";
        statusEl.dataset.state = state;
      }

      function populateLanguageSelect() {
        if (!languageSelect) return;
        languageSelect.innerHTML = "";
        LANGUAGE_OPTIONS.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.code;
          option.textContent = opt.label;
          languageSelect.appendChild(option);
        });
        languageSelect.value = currentLanguage;
        languageSelect.setAttribute("aria-label", t("languageLabel"));
      }

      function applyDualTranslations() {
        const setText = (el, key) => {
          if (el) el.textContent = t(key);
        };

        setText(document.querySelector(".dual-title"), "dualBoardLabel");
        setText(swapBtn, "dualSwap");
        setText(resetBtn, "dualReset");
        setText(showControlsBtn, "dualShowControls");
        if (showControlsBtn) showControlsBtn.setAttribute("aria-label", t("dualShowControls"));

        if (languageSelect) {
          languageSelect.setAttribute("aria-label", t("languageLabel"));
        }
        const langLabel = document.querySelector("label[for='language-select-global']");
        setText(langLabel, "languageLabel");

        if (infoBtn) infoBtn.setAttribute("aria-label", t("dualInfoLabel"));

        ["left", "right"].forEach((side) => {
          const suffix = side === "right" ? "right" : "left";
          setText(document.querySelector(`label[for='station-input-${suffix}']`), "searchStop");

          const favLabelEl = document.querySelector(
            `#favorites-only-toggle-${suffix} .fav-pill__label`,
          );
          setText(favLabelEl, "filterFavoritesOnlyShort");

          const favTitle = document.getElementById(`favorites-popover-title-${suffix}`);
          setText(favTitle, "filterFavoritesTitle");

          const favEmpty = document.getElementById(`favorites-empty-${suffix}`);
          setText(favEmpty, "filterNoFavorites");

          const filtersButtonLabel = document.querySelector(
            `#filters-open-${suffix} span:last-child`,
          );
          setText(filtersButtonLabel, "filterButton");

          const filtersTitle = document.getElementById(`filters-sheet-title-${suffix}`);
          setText(filtersTitle, "filterButton");

          const filterSectionTitle = document.querySelector(
            `#filters-popover-${suffix} .filters-section__title`,
          );
          setText(filterSectionTitle, "filterDisplay");

          const filterHideLabel = document.querySelector(
            `#filters-popover-${suffix} .switch-label`,
          );
          setText(filterHideLabel, "filterHideDeparture");

          const filterResetBtn = document.querySelector(`[data-filter-reset='${suffix}']`);
          setText(filterResetBtn, "filterReset");

          const filterApplyBtn = document.querySelector(`[data-filter-apply='${suffix}']`);
          setText(filterApplyBtn, "filterApply");

          const viewLabel = document
            .querySelector(`#view-segment-${suffix}`)
            ?.parentElement?.querySelector(".quick-controls__label");
          setText(viewLabel, "filterDisplay");

          const geoBtn = document.getElementById(`station-search-${suffix}`);
          if (geoBtn) {
            const nearLabel = t("nearbyButton");
            geoBtn.setAttribute("aria-label", nearLabel);
            geoBtn.setAttribute("title", nearLabel);
          }

          const modeLabel = document.querySelector(
            `#board-mode-toggle-${suffix} .mode-pill__label`,
          );
          setText(modeLabel, "boardModeLabel");

          const modeStateEl = document.getElementById(`board-mode-state-${suffix}`);
          if (modeStateEl) {
            const isBoard =
              document
                .getElementById(`board-mode-toggle-${suffix}`)
                ?.getAttribute("aria-pressed") !== "false";
            modeStateEl.textContent = isBoard ? t("boardModeStateOn") : t("boardModeStateOff");
          }
        });
      }

      function applyGlobalLanguage(lang, { reloadFrames = false } = {}) {
        const next = normalizeLang(lang) || currentLanguage || DEFAULT_LANG;
        currentLanguage = next;
        setLanguage(currentLanguage);
        appState.language = currentLanguage;
        appState.STATION = t("dualBoardLabel");
        if (languageSelect && languageSelect.value !== currentLanguage) {
          languageSelect.value = currentLanguage;
        }
        leftPicker?.setLanguage(currentLanguage, { silent: true });
        rightPicker?.setLanguage(currentLanguage, { silent: true });
        applyDualTranslations();
        leftPicker?.refreshLanguageUi();
        rightPicker?.refreshLanguageUi();
        updateControlsVisibility(controls?.classList.contains("is-collapsed"));
        syncFullscreenLabel();
        if (reloadFrames) {
          applyFrames({ updateQuery: true, showStatus: true });
        }
      }

      const isUrlish = (value) => /^https?:\/\//i.test((value || "").trim());

      function sanitizeUrl(url) {
        if (!url) return "";
        try {
          const parsed = new URL(url, window.location.href);
          if (parsed.protocol !== "http:" && parsed.protocol !== "https:") return "";
          return parsed.toString();
        } catch {
          return "";
        }
      }

      function normalizeLang(lang) {
        const raw = (lang || "").toLowerCase().trim();
        if (!raw) return null;
        if (VALID_LANGS.has(raw)) return raw;
        const short = raw.slice(0, 2);
        return VALID_LANGS.has(short) ? short : null;
      }

      function normalizeView(view) {
        const raw = (view || "").toLowerCase();
        return VALID_VIEWS.has(raw) ? raw : null;
      }

      function parseHide(value) {
        if (value === null || value === undefined) return null;
        const raw = String(value).toLowerCase();
        if (["1", "true", "yes", "on"].includes(raw)) return true;
        if (["0", "false", "no", "off"].includes(raw)) return false;
        return null;
      }

      function parseApiModeValue(value) {
        const raw = (value || "").toLowerCase();
        if (raw === "direct" || raw === "off") return API_MODE_DIRECT;
        if (raw === "board" || raw === "on") return API_MODE_BOARD;
        return null;
      }

      function normalizeState(input, defaults) {
        const base = { ...defaults };
        if (!input) return base;

        if (input.stationName) base.stationName = String(input.stationName).trim();
        if (input.stationId) base.stationId = String(input.stationId).trim();

        const view = normalizeView(input.view);
        if (view) base.view = view;

        const busView = normalizeView(input.busView);
        if (busView) base.busView = busView;

        const trainView = normalizeView(input.trainView);
        if (trainView) base.trainView = trainView;

        const hide = typeof input.hideDeparture === "boolean" ? input.hideDeparture : parseHide(input.hideDeparture);
        if (hide !== null) base.hideDeparture = !!hide;

        const mode = parseApiModeValue(input.apiMode);
        if (mode) base.apiMode = mode;

        const lang = normalizeLang(input.language);
        if (lang) base.language = lang;

        if (input.customUrl) {
          base.customUrl = sanitizeUrl(input.customUrl) || null;
        } else if ("customUrl" in input) {
          base.customUrl = null;
        }

        base.view = normalizeView(base.view) || VIEW_MODE_LINE;
        base.busView = normalizeView(base.busView);
        base.trainView = normalizeView(base.trainView);
        base.apiMode = base.apiMode === API_MODE_DIRECT ? API_MODE_DIRECT : API_MODE_BOARD;
        base.hideDeparture = !!base.hideDeparture;
        base.language = normalizeLang(base.language) || defaults.language || DEFAULT_LANG;

        return base;
      }

      function parseBoardUrl(raw) {
        const clean = sanitizeUrl(raw);
        if (!clean) return null;
        let parsed;
        try {
          parsed = new URL(clean);
        } catch {
          return { customUrl: clean };
        }
        const params = parsed.searchParams;
        const stationName = params.get("stationName");
        const stationId = params.get("stationId");
        const view = normalizeView(params.get("view"));
        const hide = parseHide(params.get("hideDeparture"));
        const language = normalizeLang(params.get("lang"));
        const apiMode = parseApiModeValue(params.get("mode") || params.get("apiMode"));
        const isSameApp =
          parsed.origin === window.location.origin || parsed.hostname.includes("mesdeparts");

        const state = {
          stationName: stationName || null,
          stationId: stationId || null,
          view,
          hideDeparture: hide,
          language,
          apiMode,
        };

        if (!isSameApp) {
          state.customUrl = clean;
        }
        return state;
      }

      function buildBoardUrl(state, defaults = LEFT_DEFAULT) {
        const s = normalizeState(state, defaults || LEFT_DEFAULT);
        if (s.customUrl) return s.customUrl;

        const url = new URL(BASE_BOARD_URL);
        url.search = "";

        if (s.stationName) url.searchParams.set("stationName", s.stationName);
        if (s.stationId) url.searchParams.set("stationId", s.stationId);
        if (s.view && VALID_VIEWS.has(s.view)) url.searchParams.set("view", s.view);
        if (s.hideDeparture) url.searchParams.set("hideDeparture", "1");
        if (s.language && VALID_LANGS.has(s.language)) url.searchParams.set("lang", s.language);
        url.searchParams.set("mode", s.apiMode === API_MODE_DIRECT ? "direct" : "board");

        return url.toString();
      }

      function debounce(fn, wait = 200) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function loadStoredStates() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return {
            left: normalizeState(parsed.left, LEFT_DEFAULT),
            right: normalizeState(parsed.right, RIGHT_DEFAULT),
          };
        } catch {
          return {};
        }
      }

      function loadLegacyStates() {
        try {
          const raw = localStorage.getItem(LEGACY_STORAGE_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return {
            left: parsed.left ? normalizeState(parseBoardUrl(parsed.left), LEFT_DEFAULT) : null,
            right: parsed.right ? normalizeState(parseBoardUrl(parsed.right), RIGHT_DEFAULT) : null,
          };
        } catch {
          return {};
        }
      }

      function initialStateForSide(side, stored, legacy) {
        const defaults = side === "left" ? LEFT_DEFAULT : RIGHT_DEFAULT;
        const fromUrl = params.get(side);
        if (fromUrl) {
          return normalizeState(parseBoardUrl(fromUrl), defaults);
        }
        const saved = stored[side];
        if (saved) return normalizeState(saved, defaults);
        const legacyVal = legacy[side];
        if (legacyVal) return normalizeState(legacyVal, defaults);
        return { ...defaults };
      }

      class DualPicker {
        constructor(side, defaults, initialState, onChange) {
          this.side = side;
          this.defaults = defaults;
          this.state = normalizeState(initialState, defaults);
          this.state.language = currentLanguage;
          this.isTrainBoard = isTrainView(this.state.view);
          this.busView = isBusView(this.state.busView)
            ? this.state.busView
            : isBusView(this.state.view)
              ? this.state.view
              : VIEW_MODE_LINE;
          this.trainView = isTrainView(this.state.trainView)
            ? this.state.trainView
            : isTrainView(this.state.view)
              ? this.state.view
              : TRAIN_FILTER_ALL;
          this.state.view = this.isTrainBoard ? this.trainView : this.busView;
          this.pendingHideDeparture = this.state.hideDeparture;
          this.onChange = onChange;
          this.label = sideLabel(side);
          this.suggestToken = 0;

          const suffix = side === "right" ? "right" : "left";
          this.els = {
            input: document.getElementById(`station-input-${suffix}`),
            suggestions: document.getElementById(`station-suggestions-${suffix}`),
            geoBtn: document.getElementById(`station-search-${suffix}`),
            favToggle: document.getElementById(`station-fav-toggle-${suffix}`),
            favoritesBtn: document.getElementById(`favorites-only-toggle-${suffix}`),
            favoritesPopover: document.getElementById(`favorites-popover-${suffix}`),
            favoritesList: document.getElementById(`favorites-chip-list-${suffix}`),
            favoritesEmpty: document.getElementById(`favorites-empty-${suffix}`),
            viewSegment: document.getElementById(`view-segment-${suffix}`),
            filtersOpen: document.getElementById(`filters-open-${suffix}`),
            filtersPopover: document.getElementById(`filters-popover-${suffix}`),
            filtersHide: document.getElementById(`filters-hide-departure-${suffix}`),
            filtersReset: document.querySelector(`[data-filter-reset='${suffix}']`),
            filtersApply: document.querySelector(`[data-filter-apply='${suffix}']`),
            filtersClose: document.querySelector(`[data-filter-close='${suffix}']`),
            modeToggle: document.getElementById(`board-mode-toggle-${suffix}`),
            modeState: document.getElementById(`board-mode-state-${suffix}`),
          };

          this.debouncedSuggest = debounce((q) => this.fetchSuggestions(q), 180);
          this.syncAll();
          this.bindEvents();
        }

        syncAll() {
          this.syncInputValue();
          this.renderViewControls();
          this.syncModeToggle();
          this.syncHideToggle();
          this.syncFavToggle();
          this.renderFavoritesList();
        }

        syncInputValue() {
          if (this.els.input) {
            this.els.input.value = this.state.stationName || this.state.customUrl || "";
          }
        }

        renderViewControls() {
          if (!this.els.viewSegment) return;
          const segment = this.els.viewSegment;
          segment.innerHTML = "";

          const options = this.isTrainBoard ? TRAIN_VIEW_OPTIONS : BUS_VIEW_OPTIONS;
          const active = this.isTrainBoard
            ? normalizeViewByType(this.trainView || this.state.view, true)
            : normalizeViewByType(this.busView || this.state.view, false);
          this.state.view = active;
          if (this.isTrainBoard) this.trainView = active;
          else this.busView = active;

          options.forEach((opt) => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "segmented-btn";
            b.dataset.view = opt.v;
            const isActive = opt.v === active;
            b.classList.toggle("is-active", isActive);
            b.setAttribute("aria-pressed", isActive ? "true" : "false");
            b.textContent = opt.label();
            b.addEventListener("click", () => {
              if (this.isTrainBoard) this.setTrainFilter(opt.v);
              else this.setView(opt.v);
            });
            segment.appendChild(b);
          });
        }

        syncModeToggle() {
          if (!this.els.modeToggle) return;
          const isBoard = this.state.apiMode !== API_MODE_DIRECT;
          const labelEl = this.els.modeToggle.querySelector(".mode-pill__label");
          this.els.modeToggle.classList.toggle("is-active", isBoard);
          this.els.modeToggle.setAttribute("aria-pressed", isBoard ? "true" : "false");
          if (labelEl) labelEl.textContent = t("boardModeLabel");
          if (this.els.modeState) {
            this.els.modeState.textContent = isBoard ? t("boardModeStateOn") : t("boardModeStateOff");
          }
        }

        syncHideToggle() {
          if (this.els.filtersHide) {
            const disabled = !!this.isTrainBoard;
            this.els.filtersHide.checked = disabled ? false : !!this.pendingHideDeparture;
            this.els.filtersHide.disabled = disabled;
          }
        }

        syncFavToggle() {
          if (!this.els.favToggle) return;
          const hasId = !!this.state.stationId;
          const fav = hasId ? isFavorite(this.state.stationId) : false;
          this.els.favToggle.disabled = !hasId;
          this.els.favToggle.setAttribute("aria-pressed", fav ? "true" : "false");
          const icon = this.els.favToggle.querySelector(".fav-toggle__icon");
          if (icon) icon.textContent = fav ? "★" : "☆";
        }

        bindEvents() {
          if (this.els.input) {
            this.els.input.addEventListener("input", (e) => {
              const q = e.target.value.trim();
              if (!q || q.length < 2 || isUrlish(q)) {
                this.clearSuggestions();
                return;
              }
              this.debouncedSuggest(q);
            });
            this.els.input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                this.applyInputValue();
              } else if (e.key === "Escape") {
                this.clearSuggestions();
              }
            });
            this.els.input.addEventListener("focus", () => {
              if (this.els.input.value.trim().length >= 2) {
                this.debouncedSuggest(this.els.input.value.trim());
              }
            });
            this.els.input.addEventListener("blur", () => {
              setTimeout(() => this.clearSuggestions(), 150);
            });
          }

          if (this.els.suggestions) {
            this.els.suggestions.addEventListener("click", (e) => {
              const li = e.target.closest(".station-suggestion-item");
              if (!li || !li.dataset.id) return;
              this.setStation(li.dataset.name, li.dataset.id);
              this.clearSuggestions();
            });
          }

          if (this.els.geoBtn) {
            this.els.geoBtn.addEventListener("click", () => this.handleGeo());
          }

          if (this.els.favToggle) {
            this.els.favToggle.addEventListener("click", () => this.toggleFavorite());
          }

          if (this.els.favoritesBtn) {
            this.els.favoritesBtn.addEventListener("click", () => this.toggleFavoritesPopover());
          }

          if (this.els.filtersOpen) {
            this.els.filtersOpen.addEventListener("click", () => this.openFilters());
          }
          if (this.els.filtersClose) {
            this.els.filtersClose.addEventListener("click", () => this.closeFilters());
          }
          if (this.els.filtersApply) {
            this.els.filtersApply.addEventListener("click", () => this.applyFilters());
          }
          if (this.els.filtersReset) {
            this.els.filtersReset.addEventListener("click", () => this.resetFilters());
          }
          if (this.els.filtersHide) {
            this.els.filtersHide.addEventListener("change", () => {
              this.pendingHideDeparture = !!this.els.filtersHide.checked;
            });
          }

          if (this.els.modeToggle) {
            this.els.modeToggle.addEventListener("click", () => {
              this.state.apiMode =
                this.state.apiMode === API_MODE_DIRECT ? API_MODE_BOARD : API_MODE_DIRECT;
              this.syncModeToggle();
              this.triggerChange();
            });
          }
        }

        setView(view) {
          const next = normalizeView(view) || VIEW_MODE_LINE;
          if (!isBusView(next)) return;
          this.isTrainBoard = false;
          if (this.busView === next) return;
          this.busView = next;
          this.state.view = this.busView;
          this.renderViewControls();
          this.triggerChange();
        }

        setTrainFilter(filter) {
          const next = normalizeView(filter) || TRAIN_FILTER_ALL;
          if (!isTrainView(next)) return;
          this.isTrainBoard = true;
          if (this.trainView === next) return;
          this.trainView = next;
          this.state.view = this.trainView;
          this.renderViewControls();
          this.triggerChange();
        }

        openFilters() {
          if (!this.els.filtersPopover || !this.els.filtersOpen) return;
          this.pendingHideDeparture = !!this.state.hideDeparture;
          this.syncHideToggle();
          this.els.filtersPopover.classList.remove("is-hidden");
          this.els.filtersPopover.setAttribute("aria-hidden", "false");
          if ("inert" in this.els.filtersPopover) {
            this.els.filtersPopover.inert = false;
          }
          this.els.filtersOpen.setAttribute("aria-expanded", "true");
        }

        closeFilters() {
          if (!this.els.filtersPopover || !this.els.filtersOpen) return;
          const active = document.activeElement;
          if (active && this.els.filtersPopover.contains(active)) {
            if (typeof this.els.filtersOpen.focus === "function") {
              this.els.filtersOpen.focus();
            } else if (typeof active.blur === "function") {
              active.blur();
            }
          }
          if ("inert" in this.els.filtersPopover) {
            this.els.filtersPopover.inert = true;
          }
          this.els.filtersPopover.classList.add("is-hidden");
          this.els.filtersPopover.setAttribute("aria-hidden", "true");
          this.els.filtersOpen.setAttribute("aria-expanded", "false");
        }

        applyFilters() {
          this.state.hideDeparture = !!this.pendingHideDeparture;
          this.syncHideToggle();
          this.closeFilters();
          this.triggerChange();
        }

        resetFilters() {
          this.pendingHideDeparture = false;
          this.state.hideDeparture = false;
          this.syncHideToggle();
          this.closeFilters();
          this.triggerChange();
        }

        clearSuggestions() {
          if (this.els.suggestions) {
            this.els.suggestions.innerHTML = "";
            this.els.suggestions.style.display = "none";
          }
        }

        renderSuggestions(list) {
          if (!this.els.suggestions) return;
          this.els.suggestions.innerHTML = "";
          if (!list || !list.length) {
            this.els.suggestions.style.display = "none";
            return;
          }
          const frag = document.createDocumentFragment();
          list.forEach((item) => {
            const li = document.createElement("li");
            li.className = "station-suggestion-item";
            li.dataset.id = item.id;
            li.dataset.name = item.name;
            li.textContent = item.name;
            frag.appendChild(li);
          });
          this.els.suggestions.appendChild(frag);
          this.els.suggestions.style.display = "";
        }

        async fetchSuggestions(query) {
          if (!query || query.length < 2) {
            this.clearSuggestions();
            return;
          }
          const token = ++this.suggestToken;
          try {
            const list = await fetchStationSuggestions(query);
            if (token !== this.suggestToken) return;
            this.renderSuggestions(list);
          } catch {
            this.clearSuggestions();
          }
        }

        async applyInputValue() {
          if (!this.els.input) return;
          const value = this.els.input.value.trim();
          if (!value) return;
          const resolved = await resolveInputValue(value);
          if (!resolved) {
            setStatus(`${this.label}: ${t("dualStatusEnterStation")}`, "error");
            return;
          }
          const next = { ...this.state, ...resolved, customUrl: resolved.customUrl || null };
          this.state = normalizeState(next, this.defaults);
          this.pendingHideDeparture = this.state.hideDeparture;
          this.syncAll();
          this.clearSuggestions();
          this.triggerChange();
        }

        setStation(name, id) {
          this.state = normalizeState(
            { ...this.state, stationName: name, stationId: id, customUrl: null },
            this.defaults,
          );
          this.pendingHideDeparture = this.state.hideDeparture;
          this.syncAll();
          this.clearSuggestions();
          this.triggerChange();
        }

        async handleGeo() {
          if (!this.els.geoBtn) return;
          this.setGeoLoading(true);
          try {
            const pos = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 12000,
                maximumAge: 60000,
              });
            });
            const stations = await fetchStationsNearby(
              pos.coords.latitude,
              pos.coords.longitude,
              8,
            );
            if (!stations.length) {
              setStatus(`${this.label}: ${t("dualStatusNoNearby")}`, "error");
              return;
            }
            const first = stations[0];
            this.setStation(first.name, first.id);
            setStatus(`${this.label}: ${first.name}`);
          } catch {
            setStatus(`${this.label}: ${t("dualStatusGeoUnavailable")}`, "error");
          } finally {
            this.setGeoLoading(false);
          }
        }

        setGeoLoading(on) {
          if (!this.els.geoBtn) return;
          this.els.geoBtn.disabled = !!on;
          this.els.geoBtn.classList.toggle("is-loading", !!on);
          this.els.geoBtn.setAttribute("aria-busy", on ? "true" : "false");
          if (!on) this.els.geoBtn.removeAttribute("aria-busy");
        }

        toggleFavorite() {
          if (!this.state.stationId) {
            setStatus(`${this.label}: ${t("dualStatusSelectBeforeFavorite")}`, "error");
            return;
          }
          const isFav = isFavorite(this.state.stationId);
          if (isFav) {
            removeFavorite(this.state.stationId);
          } else {
            addFavorite({ id: this.state.stationId, name: this.state.stationName || "" });
          }
          this.syncFavToggle();
          this.renderFavoritesList();
        }

        positionFavoritesPopover() {
          if (!this.els.favoritesPopover || !this.els.favoritesBtn) return;
          const popover = this.els.favoritesPopover;
          const trigger = this.els.favoritesBtn;
          const margin = 8;
          popover.classList.add("is-floating");
          popover.style.position = "fixed";
          popover.style.transform = "none";
          popover.style.right = "auto";
          popover.style.left = "0px";
          popover.style.top = "0px";

          const viewportWidth = Math.max(
            window.innerWidth || 0,
            document.documentElement?.clientWidth || 0,
          );
          const viewportHeight = Math.max(
            window.innerHeight || 0,
            document.documentElement?.clientHeight || 0,
          );
          const btnRect = trigger.getBoundingClientRect();
          const popRect = popover.getBoundingClientRect();

          const maxLeft = Math.max(margin, viewportWidth - popRect.width - margin);
          const left = Math.max(margin, Math.min(btnRect.left, maxLeft));

          const desiredTop = btnRect.bottom + margin;
          const maxTop = Math.max(margin, viewportHeight - popRect.height - margin);
          const top = Math.min(Math.max(margin, desiredTop), maxTop);

          popover.style.left = `${left}px`;
          popover.style.top = `${top}px`;
        }

        toggleFavoritesPopover() {
          if (!this.els.favoritesPopover || !this.els.favoritesBtn) return;
          const isOpen = !this.els.favoritesPopover.classList.contains("is-hidden");
          if (isOpen) {
            this.closeFavoritesPopover();
          } else {
            this.renderFavoritesList();
            this.els.favoritesPopover.classList.remove("is-hidden");
            this.els.favoritesBtn.setAttribute("aria-expanded", "true");
            this.positionFavoritesPopover();
          }
        }

        closeFavoritesPopover() {
          if (!this.els.favoritesPopover || !this.els.favoritesBtn) return;
          this.els.favoritesPopover.classList.add("is-hidden");
          this.els.favoritesBtn.setAttribute("aria-expanded", "false");
          this.els.favoritesPopover.classList.remove("is-floating");
          this.els.favoritesPopover.style.left = "";
          this.els.favoritesPopover.style.top = "";
          this.els.favoritesPopover.style.right = "";
          this.els.favoritesPopover.style.position = "";
          this.els.favoritesPopover.style.transform = "";
        }

        renderFavoritesList() {
          if (!this.els.favoritesList || !this.els.favoritesPopover) return;
          const favs = loadFavorites();
          this.els.favoritesList.innerHTML = "";
          if (this.els.favoritesEmpty) {
            this.els.favoritesEmpty.classList.toggle("is-hidden", favs.length > 0);
          }
          if (!favs.length) return;

          const frag = document.createDocumentFragment();
          favs.forEach((fav) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "filter-chip";
            btn.textContent = fav.name;
            btn.addEventListener("click", () => {
              this.setStation(fav.name, fav.id);
              this.closeFavoritesPopover();
            });
            frag.appendChild(btn);
          });
          this.els.favoritesList.appendChild(frag);
        }

        handleGlobalResize() {
          if (
            this.els.favoritesPopover &&
            !this.els.favoritesPopover.classList.contains("is-hidden")
          ) {
            this.positionFavoritesPopover();
          }
        }

        handleGlobalClick(event) {
          if (this.els.favoritesPopover && !this.els.favoritesPopover.classList.contains("is-hidden")) {
            const inPopover =
              this.els.favoritesPopover.contains(event.target) ||
              (this.els.favoritesBtn && this.els.favoritesBtn.contains(event.target));
            if (!inPopover) {
              this.closeFavoritesPopover();
            }
          }
          if (this.els.filtersPopover && !this.els.filtersPopover.classList.contains("is-hidden")) {
            const inFilters =
              this.els.filtersPopover.contains(event.target) ||
              (this.els.filtersOpen && this.els.filtersOpen.contains(event.target));
            if (!inFilters) {
              this.closeFilters();
            }
          }
        }

        setBoardType(isTrain, view, hideDeparture, { silent = false } = {}) {
          this.isTrainBoard = !!isTrain;
          const nextView = normalizeView(view);
          if (nextView) {
            if (this.isTrainBoard && isTrainView(nextView)) {
              this.trainView = nextView;
            } else if (!this.isTrainBoard && isBusView(nextView)) {
              this.busView = nextView;
            }
          }

          this.state.view = this.isTrainBoard ? this.trainView : this.busView;

          if (typeof hideDeparture === "boolean") {
            this.state.hideDeparture = this.isTrainBoard ? false : !!hideDeparture;
            this.pendingHideDeparture = this.state.hideDeparture;
          }

          this.renderViewControls();
          this.syncHideToggle();
          this.syncFavToggle();
          if (!silent) this.triggerChange();
        }

        getUrl() {
          const viewForUrl = this.isTrainBoard ? this.trainView : this.busView;
          return buildBoardUrl({ ...this.state, view: viewForUrl }, this.defaults);
        }

        getSerializableState() {
          return {
            stationName: this.state.stationName,
            stationId: this.state.stationId,
            view: this.state.view,
            busView: this.busView,
            trainView: this.trainView,
            hideDeparture: this.state.hideDeparture,
            apiMode: this.state.apiMode,
            language: this.state.language,
            customUrl: this.state.customUrl || null,
          };
        }

        applyState(next, { silent = false } = {}) {
          this.state = normalizeState(next, this.defaults);
          this.busView = isBusView(this.state.busView)
            ? this.state.busView
            : isBusView(this.state.view)
            ? this.state.view
            : this.busView || VIEW_MODE_LINE;
          this.trainView = isTrainView(this.state.trainView)
            ? this.state.trainView
            : isTrainView(this.state.view)
            ? this.state.view
            : this.trainView || TRAIN_FILTER_ALL;
          if (isTrainView(this.state.view)) {
            this.isTrainBoard = true;
          } else if (isBusView(this.state.view)) {
            this.isTrainBoard = false;
          }
          this.state.view = this.isTrainBoard ? this.trainView : this.busView;
          this.pendingHideDeparture = this.state.hideDeparture;
          this.syncAll();
          if (!silent) this.triggerChange();
        }

        triggerChange() {
          if (typeof this.onChange === "function") this.onChange();
        }

        getDisplayName() {
          return this.state.stationName || t("dualBoardLabel");
        }

        setLanguage(lang, { silent = false } = {}) {
          const next = normalizeLang(lang) || currentLanguage || DEFAULT_LANG;
          this.state.language = next;
          this.label = sideLabel(this.side);
          this.renderViewControls();
          this.syncModeToggle();
          this.syncHideToggle();
          this.syncFavToggle();
          if (!silent) this.triggerChange();
        }

        refreshLanguageUi() {
          this.setLanguage(this.state.language, { silent: true });
        }
      }

      const pickers = [];

      async function resolveInputValue(value) {
        if (!value) return null;
        if (isUrlish(value)) {
          return parseBoardUrl(value) || { customUrl: sanitizeUrl(value) };
        }
        if (value.length < 2) return { stationName: value };
        try {
          const list = await fetchStationSuggestions(value);
          const first = Array.isArray(list) ? list[0] : null;
          if (first && first.name) {
            return { stationName: first.name, stationId: first.id };
          }
        } catch {
          // ignore
        }
        return { stationName: value };
      }

      const defaultsWithLanguage = (defaults) => ({ ...defaults, language: currentLanguage });
      const scheduleApplyFrames = debounce(() => applyFrames(), 120);

      const stored = loadStoredStates();
      const legacy = loadLegacyStates();

      const leftPicker = new DualPicker(
        "left",
        LEFT_DEFAULT,
        initialStateForSide("left", stored, legacy),
        () => scheduleApplyFrames(),
      );
      const rightPicker = new DualPicker(
        "right",
        RIGHT_DEFAULT,
        initialStateForSide("right", stored, legacy),
        () => scheduleApplyFrames(),
      );
      pickers.push(leftPicker, rightPicker);

      const handleGlobalClick = (event) => {
        pickers.forEach((p) => p?.handleGlobalClick?.(event));
      };
      const handleGlobalResize = () => {
        pickers.forEach((p) => p?.handleGlobalResize?.());
      };

      document.addEventListener("click", handleGlobalClick);
      window.addEventListener("resize", handleGlobalResize, { passive: true });

      populateLanguageSelect();
      applyGlobalLanguage(currentLanguage, { reloadFrames: false });

      if (languageSelect) {
        languageSelect.addEventListener("change", () => {
          applyGlobalLanguage(languageSelect.value, { reloadFrames: true });
        });
      }

      function saveStates(leftState, rightState) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ left: leftState, right: rightState }));
        } catch {
          // ignore
        }
      }

      let lastAppliedLeftUrl = "";
      let lastAppliedRightUrl = "";

      function applyFrames({ updateQuery = true, showStatus = true } = {}) {
        if (!leftPicker || !rightPicker || !leftFrame || !rightFrame) return false;

        const leftUrl = leftPicker.getUrl();
        const rightUrl = rightPicker.getUrl();
        if (!leftUrl || !rightUrl) {
          if (showStatus) setStatus(t("dualStatusFillBoth"), "error");
          return false;
        }

        const leftChanged = leftUrl !== lastAppliedLeftUrl;
        const rightChanged = rightUrl !== lastAppliedRightUrl;

        if (leftChanged) {
          leftFrame.src = leftUrl;
          lastAppliedLeftUrl = leftUrl;
        }
        if (rightChanged) {
          rightFrame.src = rightUrl;
          lastAppliedRightUrl = rightUrl;
        }

        if (updateQuery && (leftChanged || rightChanged)) {
          const nextParams = new URLSearchParams(window.location.search || "");
          nextParams.set("left", leftUrl);
          nextParams.set("right", rightUrl);
          nextParams.set("lang", currentLanguage);
          const qs = nextParams.toString();
          history.replaceState({}, "", qs ? `${window.location.pathname}?${qs}` : window.location.pathname);
        }

        saveStates(leftPicker.getSerializableState(), rightPicker.getSerializableState());

        if (showStatus && (leftChanged || rightChanged)) {
          setStatus(
            `${leftPicker.getDisplayName()} / ${rightPicker.getDisplayName()} ${t("dualStatusLoadedSuffix")}`,
          );
        }
        return true;
      }

      function tagIframeForDualEmbed(iframe) {
        if (!iframe) return;
        const applyClass = () => {
          try {
            const doc =
              iframe.contentDocument ||
              (iframe.contentWindow ? iframe.contentWindow.document : null);
            if (!doc) return;
            doc.documentElement?.classList.add("dual-embed");
            doc.body?.classList.add("dual-embed");
          } catch {
            // Ignore cross-origin frames
          }
        };
        iframe.addEventListener("load", applyClass);
      }

      tagIframeForDualEmbed(leftFrame);
      tagIframeForDualEmbed(rightFrame);

      function handleBoardStateMessage(event) {
        const data = event.data;
        if (!data || data.type !== "md-board-state") return;
        let side = null;
        if (leftFrame && event.source === leftFrame.contentWindow) side = "left";
        else if (rightFrame && event.source === rightFrame.contentWindow) side = "right";
        if (!side) return;
        const picker = side === "left" ? leftPicker : rightPicker;
        picker.setBoardType(data.isTrain, data.view, data.hideDeparture, { silent: true });
      }

      window.addEventListener("message", handleBoardStateMessage);

      applyFrames({ updateQuery: true, showStatus: false });

      function swapBoards() {
        const leftState = leftPicker.getSerializableState();
        const rightState = rightPicker.getSerializableState();
        leftPicker.applyState(rightState, { silent: true });
        rightPicker.applyState(leftState, { silent: true });
        applyFrames();
        setStatus(t("dualStatusSwapped"));
      }

      if (swapBtn) swapBtn.addEventListener("click", swapBoards);

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          leftPicker.applyState(defaultsWithLanguage(LEFT_DEFAULT), { silent: true });
          rightPicker.applyState(defaultsWithLanguage(RIGHT_DEFAULT), { silent: true });
          applyFrames();
          setStatus(t("dualStatusReset"));
        });
      }

      function updateControlsVisibility(collapsed) {
        const bodyEl = document.body;
        if (controls) {
          controls.classList.toggle("is-collapsed", collapsed);
        }
        if (bodyEl) {
          bodyEl.classList.toggle("dual-controls-hidden", collapsed);
        }
        if (hideBtn) {
          const label = collapsed ? t("dualShowControls") : t("dualHideControls");
          hideBtn.setAttribute("aria-pressed", collapsed ? "true" : "false");
          hideBtn.textContent = label;
          hideBtn.setAttribute("aria-label", label);
        }
        if (showControlsBtn) {
          showControlsBtn.setAttribute("aria-hidden", collapsed ? "false" : "true");
          showControlsBtn.textContent = t("dualShowControls");
          showControlsBtn.setAttribute("aria-label", t("dualShowControls"));
        }
      }

      function toggleControls(forceCollapsed) {
        if (!controls) return;
        const collapsed =
          typeof forceCollapsed === "boolean"
            ? forceCollapsed
            : !controls.classList.contains("is-collapsed");
        updateControlsVisibility(collapsed);
      }

      if (hideBtn) {
        hideBtn.addEventListener("click", toggleControls);
      }

      if (showControlsBtn) {
        showControlsBtn.addEventListener("click", () => toggleControls(false));
      }

      function isFullscreen() {
        return !!(document.fullscreenElement || document.webkitFullscreenElement);
      }

      function syncFullscreenLabel() {
        if (!fullscreenBtn) return;
        const key = isFullscreen() ? "dualExitFullscreen" : "dualFullscreen";
        const label = t(key);
        fullscreenBtn.textContent = label;
        fullscreenBtn.setAttribute("aria-label", label);
        document.body?.classList.toggle("is-fullscreen", isFullscreen());
      }

      async function requestFullscreen() {
        const el = document.documentElement;
        const fn =
          el.requestFullscreen ||
          el.webkitRequestFullscreen ||
          el.msRequestFullscreen ||
          el.mozRequestFullScreen;
        if (fn) {
          await fn.call(el);
          return true;
        }
        return false;
      }

      async function exitFullscreen() {
        const fn =
          document.exitFullscreen ||
          document.webkitExitFullscreen ||
          document.msExitFullscreen ||
          document.mozCancelFullScreen;
        if (fn) await fn.call(document);
      }

      if (fullscreenBtn) {
        fullscreenBtn.addEventListener("click", async () => {
          try {
            if (isFullscreen()) {
              await exitFullscreen();
            } else {
              const ok = await requestFullscreen();
              if (!ok) setStatus(t("dualStatusFullscreenUnavailable"), "error");
            }
          } catch {
            setStatus(t("dualStatusFullscreenFailed"), "error");
          } finally {
            syncFullscreenLabel();
          }
        });
      }

      document.addEventListener("fullscreenchange", syncFullscreenLabel);
      document.addEventListener("webkitfullscreenchange", syncFullscreenLabel);
      syncFullscreenLabel();

      if (autoFullscreen) {
        const enterFs = async () => {
          try {
            await requestFullscreen();
          } catch {
            // ignore
          } finally {
            syncFullscreenLabel();
            document.removeEventListener("pointerdown", enterFs);
            document.removeEventListener("keydown", enterFs);
          }
        };
        document.addEventListener("pointerdown", enterFs, { once: true });
        document.addEventListener("keydown", enterFs, { once: true });
        setStatus(t("dualStatusTapFullscreen"));
      }
    </script>
  </body>
</html>
